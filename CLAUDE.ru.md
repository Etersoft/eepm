# CLAUDE.ru.md

Этот файл содержит руководство для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

## Обзор проекта

EEPM (Etersoft EPM) — универсальная обёртка над пакетными менеджерами, предоставляющая единый интерфейс для всех дистрибутивов Linux. Оборачивает нативные пакетные менеджеры (apt, yum, dnf, zypper, pacman и др.) едиными командами.

Основные команды:
- `epm` — управление пакетами (установка, удаление, поиск и т.д.)
- `serv` — обёртка для управления сервисами (systemd, sysvinit)
- `distr_info` — утилита определения дистрибутива

## Настройка для разработки

Сборка не требуется — это проект на shell-скриптах. Запуск прямо из checkout:
```bash
./bin/epm --help
./bin/epm play --list
```

## Тестирование

Запуск отдельных тестов из каталога `tests/`:
```bash
./tests/test_distr_info.sh
./tests/test_versions.sh
./tests/test_json.sh
```

Проверка качества кода:
```bash
./check_code.sh              # Запуск shellcheck и checkbashisms для всех скриптов
./check_code.sh bin/epm-install  # Проверка конкретного файла
```

## Архитектура

### Основные скрипты (`bin/`)

- `epm` — главная точка входа, загружает хелперы через функцию `load_helper`
- `epm-sh-functions` — общие shell-функции (вывод, цвета, определение tty)
- `epm-*` — реализации команд (epm-install, epm-remove, epm-search и др.)
- `serv` — точка входа для управления сервисами
- `serv-*` — реализации команд сервисов
- `distr_info` — автономный скрипт определения дистрибутива
- `tools_*` — внутренние утилиты

Скрипт `epm` использует динамическую загрузку хелперов:
```bash
load_helper epm-sh-functions  # Загрузка общих функций
load_helper epm-install       # Загрузка конкретной команды
```

### Play-скрипты (`play.d/`)

Скрипты для установки приложений с официальных сайтов (не из репозиториев). Каждый скрипт:
- Подключает `common.sh` для общей функциональности
- Определяет: `PKGNAME`, `DESCRIPTION`, `VERSION`, `URL`, `SUPPORTEDARCHES`
- Обрабатывает: `--description`, `--package-name`, `--installed`, `--remove`, `--info`, `--update`, `--run`
- Скачивает и устанавливает пакеты через команды `epm`

Типичная структура:
```bash
BASEPKGNAME=AppName
SUPPORTEDARCHES="x86_64"
DESCRIPTION="Описание приложения"
. $(dirname $0)/common.sh
# Логика скачивания и установки
```

### Repack-скрипты (`repack.d/`)

Скрипты для конвертации пакетов между форматами (rpm↔deb) с дистрибутив-специфичными исправлениями.

### Pack-скрипты (`pack.d/`)

Скрипты для создания пакетов из архивов/бинарников. Работают во временном каталоге, возвращают архив через `return_tar`.

### Prescription-скрипты (`prescription.d/`)

Рецепты мета-пакетов для установки групп связанных пакетов.

## Ключевые функции в common.sh

- `epm` — обёртка, показывающая выполняемые команды
- `eget` — wget-подобная утилита загрузки (`epm tool eget`)
- `get_github_url` / `get_github_tag` — хелперы для релизов GitHub
- `install_pkgurl` / `install_pack_pkgurl` — установка пакетов
- `is_glibc_enough` / `is_stdcpp_enough` — проверка требований к версиям
- `fatal` / `info` — хелперы вывода

## Добавление новых play-скриптов

1. Создать `play.d/appname.sh`
2. Определить обязательные переменные (PKGNAME, DESCRIPTION, SUPPORTEDARCHES)
3. Подключить `common.sh`
4. Реализовать логику скачивания/определения версии
5. Вызвать `install_pkgurl` или `install_pack_pkgurl`

## Совместимость с shell

Все скрипты должны быть POSIX-совместимыми (избегать башизмов). Использовать `#!/bin/sh` для большинства скриптов. Скрипт `check_code.sh` проверяет это через `checkbashisms`.
